<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Assistant ALTRAD METRIX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #f9fafb;
        color: #111827;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, sans-serif;
      }
      .wrap {
        max-width: 48rem;
        margin: 0 auto;
        padding: 1rem;
      }
      h1 {
        font-size: 1.5rem;
        font-weight: 600;
        letter-spacing: -0.01em;
        margin: 0 0 0.5rem;
      }
      .subtitle {
        font-size: 0.9rem;
        color: #6b7280;
        background: #e5e7eb;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
      }
      .messages {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding-bottom: 0.75rem;
        min-height: 200px;
      }
      .msg {
        display: flex;
        flex-direction: column;
        max-width: 80%;
      }
      .bubble {
        border-radius: 12px;
        padding: 10px 12px;
        white-space: pre-wrap;
        line-height: 1.4;
      }
      .user {
        align-self: flex-end;
      }
      .user .bubble {
        background: #2563eb;
        color: #fff;
      }
      .assistant {
        align-self: flex-start;
      }
      .assistant .bubble {
        background: #ffffff;
        color: #111827;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .system {
        align-self: center;
      }
      .system .bubble {
        background: #f3f4f6;
        color: #6b7280;
        font-style: italic;
      }
      .time {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.25rem;
        padding: 0 0.5rem;
      }
      .composer {
        position: sticky;
        bottom: 0;
        display: flex;
        gap: 0.5rem;
        padding-top: 0.5rem;
        background: #f9fafb;
      }
      .composer input {
        flex: 1;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        padding: 0.5rem 0.75rem;
        font-size: 15px;
        background: #ffffff;
      }
      .composer button {
        padding: 0.5rem 0.9rem;
        border: none;
        border-radius: 999px;
        background: #2563eb;
        color: #ffffff;
        font-size: 0.875rem;
        cursor: pointer;
      }
      .composer button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .assistant-content table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        margin: 0.5rem 0;
      }
      .assistant-content th,
      .assistant-content td {
        padding: 8px 10px;
        border-top: 1px solid #f1f5f9;
        text-align: left;
        vertical-align: middle;
      }
      .assistant-content thead th {
        background: #f3f4f6;
        font-weight: 600;
      }
      .assistant-content tr:nth-child(even) td {
        background: #fafafa;
      }
      .assistant-content .num {
        text-align: right;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Assistant ALTRAD METRIX</h1>
      <div class="subtitle">
        Bienvenue ! Je t'aide Ã  configurer ton Ã©chafaudage ALTRAD METRIX (liste
        de matÃ©riel prÃªte Ã  commander).
      </div>

      <div id="messages" class="messages"></div>

      <div class="composer">
        <input
          id="input"
          placeholder="DÃ©cris ta configuration (ex. : 5 m Ã— 6 m Ã— 1 m)â€¦"
        />
        <button id="send">Envoyer</button>
      </div>
    </div>

    <script>
      const $messages = document.getElementById("messages");
      const $input = document.getElementById("input");
      const $send = document.getElementById("send");

      // ðŸ‘‰ historique complet envoyÃ© Ã  l'API Ã  chaque fois
      const history = [];

      function time() {
        return new Date().toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function addMessage(role, content) {
        const box = document.createElement("div");
        box.className = "msg " + role;

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        if (role === "user") {
          box.classList.add("user");
        } else if (role === "assistant") {
          box.classList.add("assistant");
        } else if (role === "system") {
          box.classList.add("system");
        }

        bubble.textContent = content;
        box.appendChild(bubble);

        if (role !== "system") {
          const stamp = document.createElement("div");
          stamp.className = "time";
          stamp.textContent = time();
          box.appendChild(stamp);
        }

        $messages.appendChild(box);
        $messages.scrollTop = $messages.scrollHeight;

        // on garde l'historique pour l'API
        history.push({ role, content });
      }

      // message systÃ¨me de bienvenue (non envoyÃ© Ã  l'API, juste visuel)
      addMessage(
        "system",
        "Tu peux me demander un Ã©chafaudage droit de faÃ§ade en me donnant la longueur et la hauteur, par exemple : 5 m de long et 6 m de haut."
      );

      async function callApiChat(userText) {
        try {
          const params = new URLSearchParams(window.location.search);
          const email = params.get("email") || "";

          // on ajoute le message utilisateur Ã  l'historique AVANT l'appel
          history.push({ role: "user", content: userText });

          const payload = {
            messages: history,
            user: { email },
          };

          const resp = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!resp.ok) {
            throw new Error("Erreur API " + resp.status);
          }

          const text = await resp.text();

          // on affiche la rÃ©ponse
          addMessage("assistant", text);
        } catch (e) {
          console.error(e);
          addMessage(
            "assistant",
            "DÃ©solÃ©, une erreur est survenue en parlant au serveur."
          );
        }
      }

      async function send() {
        const v = $input.value.trim();
        if (!v) return;
        $input.value = "";
        $send.disabled = true;

        // affiche le message user
        addMessage("user", v);

        await callApiChat(v);

        $send.disabled = false;
        $input.focus();
      }

      $send.addEventListener("click", send);
      $input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") send();
      });
    </script>
  </body>
</html>

