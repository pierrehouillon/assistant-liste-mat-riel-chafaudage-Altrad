<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Assistant ALTRAD METRIX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f3f4f6;
        color: #111827;
        height: 100%;
      }
      .wrap {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }
      h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 4px;
      }
      .subtitle {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 16px;
      }
      .messages {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px 0 80px;
        min-height: 200px;
      }
      .msg-row {
        display: flex;
      }
      .msg-row.user {
        justify-content: flex-end;
      }
      .msg-row.assistant,
      .msg-row.system {
        justify-content: flex-start;
      }
      .bubble {
        max-width: 70%;
        border-radius: 16px;
        padding: 10px 12px;
        white-space: pre-wrap;
        line-height: 1.4;
        font-size: 15px;
      }
      .bubble.user {
        background: #2563eb;
        color: #ffffff;
      }
      .bubble.assistant {
        background: #ffffff;
        color: #111827;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      }
      .bubble.system {
        background: #e5e7eb;
        color: #374151;
        font-style: italic;
      }
      .time {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 2px;
      }
      .composer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #f3f4f6;
        border-top: 1px solid #e5e7eb;
      }
      .composer-inner {
        max-width: 900px;
        margin: 0 auto;
        padding: 8px 16px;
        display: flex;
        gap: 8px;
      }
      .composer input {
        flex: 1;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        padding: 8px 14px;
        font-size: 15px;
        outline: none;
      }
      .composer input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 1px rgba(37,99,235,0.25);
      }
      .composer button {
        border-radius: 999px;
        border: none;
        padding: 8px 16px;
        background: #2563eb;
        color: #ffffff;
        font-size: 14px;
        cursor: pointer;
      }
      .composer button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .thinking {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Assistant ALTRAD METRIX</h1>
      <div class="subtitle">
        Bienvenue ! Je t’aide à configurer ton échafaudage ALTRAD METRIX (liste de matériel prête à commander).
      </div>

      <div id="messages" class="messages"></div>
      <div id="thinking" class="thinking"></div>
    </div>

    <div class="composer">
      <div class="composer-inner">
        <input
          id="input"
          placeholder="Décris ta configuration (ex. : 5 m × 6 m × 1 m)…"
        />
        <button id="send">Envoyer</button>
      </div>
    </div>

    <script>
      const $messages = document.getElementById("messages");
      const $input = document.getElementById("input");
      const $send = document.getElementById("send");
      const $thinking = document.getElementById("thinking");

      // Historique complet envoyé au backend
      const messages = [
        {
          role: "system",
          content:
            "Tu es ALTRAD Assistant METRIX. Tu aides un collaborateur à configurer un échafaudage droit de façade et à établir une liste de matériel prête à être commandée.",
        },
      ];

      function nowTime() {
        return new Date().toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function renderMessages() {
        $messages.innerHTML = "";
        messages.forEach((m) => {
          if (!m.content) return;
          const row = document.createElement("div");
          row.className = "msg-row " + m.role;

          const bubble = document.createElement("div");
          bubble.className = "bubble " + m.role;
          bubble.textContent = m.content;

          const time = document.createElement("div");
          time.className = "time";
          time.textContent = nowTime();

          const wrap = document.createElement("div");
          wrap.appendChild(bubble);
          if (m.role !== "system") {
            wrap.appendChild(time);
          }

          row.appendChild(wrap);
          $messages.appendChild(row);
        });

        $messages.scrollTop = $messages.scrollHeight;
      }

      async function callApi() {
        $thinking.textContent = "Je réfléchis à ta configuration…";
        $send.disabled = true;
        $input.disabled = true;
        try {
          const resp = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ messages }),
          });

          const text = await resp.text();
          messages.push({
            role: "assistant",
            content: text || "(Réponse vide)",
          });
          renderMessages();
        } catch (e) {
          messages.push({
            role: "assistant",
            content:
              "Désolé, une erreur est survenue lors de l’appel à l’API. Réessaie dans un instant.",
          });
          renderMessages();
        } finally {
          $thinking.textContent = "";
          $send.disabled = false;
          $input.disabled = false;
          $input.focus();
        }
      }

      function send() {
        const v = $input.value.trim();
        if (!v) return;
        messages.push({ role: "user", content: v });
        $input.value = "";
        renderMessages();
        callApi();
      }

      $send.addEventListener("click", send);
      $input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });

      // affichage initial (message système)
      renderMessages();
    </script>
  </body>
</html>

