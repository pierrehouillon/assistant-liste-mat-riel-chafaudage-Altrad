<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Assistant ALTRAD METRIX</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />

  <style>
    :root {
      --bg: #f9fafb;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --assistant-bg: #ffffff;
      --user-bg: #2563eb;
      --user-text: #ffffff;
      --system-bg: #f3f4f6;
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    /* App = colonne, taille écran, centrée sur grands écrans */
    body {
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 800px;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 8px 12px 10px;
    }

    /* Petit bandeau de bienvenue (sous-titre Glide) */
    .subtitle {
      font-size: 13px;
      color: var(--muted);
      background: #eef2ff;
      border-radius: 999px;
      padding: 8px 12px;
      margin-bottom: 6px;
      line-height: 1.4;
    }

    /* Zone messages scrollable */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      display: flex;
      flex-direction: column;
      max-width: 90%;
    }

    .msg.user   { align-self: flex-end; }
    .msg.assistant,
    .msg.system { align-self: flex-start; }

    .bubble {
      border-radius: var(--radius);
      padding: 9px 12px;
      font-size: 15px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }

    .bubble.user {
      background: var(--user-bg);
      color: var(--user-text);
      border-radius: 18px 18px 4px 18px;
    }

    .bubble.assistant {
      background: var(--assistant-bg);
      border: 1px solid var(--border);
      border-radius: 18px 18px 18px 4px;
    }

    .bubble.system {
      background: var(--system-bg);
      color: var(--muted);
      border-radius: 999px;
      box-shadow: none;
      font-size: 13px;
    }

    .time {
      margin-top: 2px;
      font-size: 11px;
      color: var(--muted);
      padding: 0 4px;
    }

    /* Rendu tableau "markdown" de la liste de matériel */
    .assistant-content table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      margin: 4px 0;
    }
    .assistant-content th,
    .assistant-content td {
      padding: 6px 8px;
      border-top: 1px solid #f1f5f9;
      text-align: left;
      vertical-align: middle;
    }
    .assistant-content thead th {
      background:#f3f4f6;
      font-weight:600;
    }
    .assistant-content .num {
      text-align: right;
      white-space: nowrap;
    }

    /* Barre de composition collée en bas */
    .composer {
      display: flex;
      gap: 8px;
      padding-top: 6px;
      padding-bottom: 4px;
      background: var(--bg);
      position: sticky;
      bottom: 0;
    }

    #input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 10px 14px;
      font-size: 14px;
      background: #ffffff;
      outline: none;
    }
    #input:focus { border-color: #2563eb; }

    #send {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    #send:disabled {
      opacity: .6;
      cursor: default;
    }

    .small-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      text-align: center;
    }

    @media (max-width: 600px) {
      .app { padding: 6px 8px 8px; }
      #input, #send { font-size: 14px; }
      .bubble { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="subtitle">
      Bienvenue ! Je t’aide à configurer ton échafaudage ALTRAD METRIX (liste de matériel prête à commander).
    </div>

    <div id="messages"></div>

    <div class="composer">
      <input
        id="input"
        placeholder="Décris ta configuration (ex. : 5 m × 6 m × 1 m)…"
      />
      <button id="send">Envoyer</button>
    </div>

    <div class="small-note">
      Les listes sont calculées à partir des règles ALTRAD METRIX et du bon de commande interne.
    </div>
  </div>

  <script>
    const API_URL = "/api/chat";
    const $messages = document.getElementById("messages");
    const $input = document.getElementById("input");
    const $send = document.getElementById("send");

    // on garde le thread en session pour la webview
    let threadId = sessionStorage.getItem("metrix_thread") || null;
    let sending = false;

    function time() {
      return new Date().toLocaleTimeString("fr-FR", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function addMessage(role, content, isHtml = false) {
      const box = document.createElement("div");
      box.className = "msg " + role;

      const bubble = document.createElement("div");
      bubble.className = "bubble " + role;

      if (role === "assistant" && isHtml) {
        bubble.innerHTML = content;
      } else {
        bubble.textContent = content;
      }

      box.appendChild(bubble);

      if (role !== "system") {
        const stamp = document.createElement("div");
        stamp.className = "time";
        stamp.textContent = time();
        box.appendChild(stamp);
      }

      $messages.appendChild(box);
      $messages.scrollTop = $messages.scrollHeight;
      return bubble;
    }

    // message système de départ
    addMessage(
      "system",
      "Bienvenue ! Je t’aide à configurer ton échafaudage ALTRAD METRIX (liste de matériel prête à commander)."
    );

    async function send() {
      const text = $input.value.trim();
      if (!text || sending) return;

      // message utilisateur
      addMessage("user", text);
      $input.value = "";
      $input.focus();

      // placeholder assistant
      const placeholder = addMessage("assistant", "Calcul en cours…");
      sending = true;
      $send.disabled = true;

      try {
        const body = { question: text };
        if (threadId) body.threadId = threadId;

        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const raw = await resp.text();

        let answerText = raw;
        let htmlMode = false;

        try {
          const data = JSON.parse(raw);
          if (data.threadId) {
            threadId = data.threadId;
            sessionStorage.setItem("metrix_thread", threadId);
          }
          if (typeof data.answer === "string") {
            answerText = data.answer;
          }
        } catch {
          // pas du JSON, on laisse answerText = raw
        }

        // Si l'assistant renvoie un <table> HTML, on l'affiche en HTML,
        // sinon on garde le texte brut.
        if (/<table[\s\S]*<\/table>/i.test(answerText)) {
          const match = answerText.match(/<table[\s\S]*<\/table>/i);
          const after = answerText.slice(
            answerText.indexOf(match[0]) + match[0].length
          );
          const p = after.match(/<p[\s\S]*?<\/p>/i);
          placeholder.innerHTML =
            '<div class="assistant-content">' +
            match[0] +
            (p ? p[0] : "") +
            "</div>";
        } else {
          placeholder.textContent = answerText;
        }
      } catch (e) {
        placeholder.textContent =
          "Désolé, une erreur est survenue. Réessaie dans un instant.";
        console.error(e);
      } finally {
        sending = false;
        $send.disabled = false;
      }
    }

    $send.addEventListener("click", send);
    $input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });
  </script>
</body>
</html>
