<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"
    />
    <title>Assistant ALTRAD METRIX</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --gap: 12px;
        --radius: 14px;
        --border: #e5e7eb;
        --muted: #6b7280;
        --primary: #2563eb;
        --bg-soft: #f9fafb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 16px;
        max-width: 800px;
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        color: #111827;
        background: #ffffff;
        -webkit-font-smoothing: antialiased;
      }

      h1 {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 4px;
      }
      .subtitle {
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 12px;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        margin: 12px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        background: #fff;
      }

      .row {
        display: flex;
        gap: var(--gap);
        align-items: center;
      }

      input {
        flex: 1;
        font-size: 16px;
        padding: 14px 12px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        outline: none;
        background: var(--bg-soft);
        transition: border 0.2s, background 0.2s;
      }
      input:focus {
        border-color: var(--primary);
        background: #fff;
      }

      button.primary {
        font-size: 16px;
        padding: 14px 18px;
        border-radius: var(--radius);
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      button.primary:hover {
        background: #1d4ed8;
      }

      .answer {
        white-space: pre-wrap;
        line-height: 1.5;
        margin-top: 12px;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        margin-top: 8px;
      }
      .loading {
        opacity: 0.7;
      }

      .topbar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }
      .ghost-btn {
        appearance: none;
        border: 1px solid var(--border);
        background: #fff;
        color: #111827;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
        cursor: pointer;
      }
      .ghost-btn:hover {
        background: #f3f4f6;
      }
      .flash {
        display: none;
        align-items: center;
        gap: 6px;
        border: 1px solid #d1fae5;
        background: #ecfdf5;
        color: #065f46;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
      }
      .flash.show {
        display: inline-flex;
      }

      @media (max-width: 600px) {
        input,
        button.primary {
          font-size: 15px;
        }
        .topbar {
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <h1>Assistant ALTRAD METRIX</h1>
    <p class="subtitle">
      Je tâ€™aide Ã  configurer ton Ã©chafaudage ALTRAD METRIX (liste de matÃ©riel
      prÃªte Ã  commander).
    </p>

    <div class="topbar">
      <span id="flash" class="flash">ðŸ†• Nouveau calcul dÃ©marrÃ©</span>
      <button id="newTopic" class="ghost-btn">Nouveau sujet</button>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom: 12px">
        <input
          id="q"
          placeholder="DÃ©cris ta configuration (ex : 5 m de long Ã— 6 m de haut)â€¦"
        />
        <button id="go" class="primary">Envoyer</button>
      </div>
      <div id="out" class="answer muted">
        Aucune demande pour lâ€™instant. DÃ©cris ton Ã©chafaudage pour commencer.
      </div>
    </div>

    <p class="muted">
      Les rÃ©ponses sont basÃ©es sur la notice ALTRAD METRIX et le bon de
      commande type de ton entreprise. Si une information manque, lâ€™assistant
      le prÃ©cise.
    </p>

    <script>
      const API_URL = "/api/chat";

      const qEl = document.getElementById("q");
      const goEl = document.getElementById("go");
      const outEl = document.getElementById("out");
      const newBtn = document.getElementById("newTopic");
      const flash = document.getElementById("flash");

      // On mÃ©morise le thread courant pour garder le contexte
      let threadId = localStorage.getItem("metrix_thread") || null;

      function showFlash() {
        flash.classList.add("show");
        setTimeout(() => flash.classList.remove("show"), 1600);
      }

      function startNewTopic() {
        threadId = null;
        localStorage.removeItem("metrix_thread");
        qEl.value = "";
        qEl.focus();
        outEl.classList.add("muted");
        outEl.textContent =
          "Nouveau calcul dÃ©marrÃ©. Donne-moi ta longueur et ta hauteur dâ€™Ã©chafaudage.";
        showFlash();
      }

      async function ask() {
        const question = qEl.value.trim();
        if (!question) return;

        outEl.textContent = "â³ Calcul en coursâ€¦";
        outEl.classList.add("loading");

        try {
          const r = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question, threadId }),
          });

          const data = await r.json();

          if (data?.threadId) {
            threadId = data.threadId;
            localStorage.setItem("metrix_thread", threadId);
          }

          outEl.classList.remove("muted");
          outEl.textContent = data?.answer || "âŒ Pas de rÃ©ponse.";

          qEl.value = "";
          qEl.focus();
        } catch (e) {
          outEl.classList.remove("muted");
          outEl.textContent =
            "âŒ Erreur : " + (e?.message || "Impossible dâ€™appeler lâ€™API");
        } finally {
          outEl.classList.remove("loading");
        }
      }

      newBtn.addEventListener("click", startNewTopic);
      goEl.addEventListener("click", ask);
      qEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") ask();
      });

      // Support test avec ?q= dans lâ€™URL
      const u = new URL(window.location.href);
      const initial = u.searchParams.get("q");
      if (initial) {
        startNewTopic();
        qEl.value = initial;
        ask();
      }
    </script>
  </body>
</html>
